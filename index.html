<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Timejegeren 6.4</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            -webkit-tap-highlight-color: transparent; 
            padding-top: env(safe-area-inset-top);
            padding-bottom: calc(env(safe-area-inset-bottom) + 120px); 
            background-color: #0f172a; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        /* iOS Fix: Forhindre auto-zoom ved √• ha minst 16px font p√• inputs */
        input, button, select, textarea { 
            -webkit-appearance: none; 
            appearance: none; 
            border-radius: 12px; 
            font-size: 16px !important; 
        }
        
        .modal-overlay {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.9); align-items: center; justify-content: center;
            padding: 20px;
            backdrop-filter: blur(8px);
        }
        .modal-overlay.active { display: flex !important; }

        .custom-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23fbbf24' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        .sweden-yellow { color: #fecb00; }
        .sweden-bg { background-color: #005293; }
        
        .card { background-color: #1e293b; border: 1px solid #334155; border-radius: 1.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); }
        
        .import-label {
            display: flex; align-items: center; justify-content: center;
            background-color: #334155; color: #f8fafc; font-weight: 900;
            padding: 1rem; border-radius: 1rem; border: 2px dashed #475569;
            text-transform: uppercase; font-size: 11px; letter-spacing: 0.1em;
            cursor: pointer; width: 100%;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        details summary { list-style: none; outline: none; }
        details summary::-webkit-details-marker { display: none; }
    </style>
</head>
<body class="text-gray-100 p-4">

    <div class="max-w-md mx-auto space-y-6">
        
        <!-- HEADER -->
        <header class="flex justify-between items-center border-b border-gray-800 pb-4">
            <div>
                <h1 class="text-3xl font-black text-white tracking-tighter uppercase">
                    TIMEJEGEREN <span class="text-sm sweden-yellow font-bold italic tracking-normal">v6.4</span>
                </h1>
                <p class="text-[10px] text-gray-500 uppercase tracking-widest font-black">&copy; Joakim S√∂derstr√∂m</p>
            </div>
            <button onclick="window.showSettings()" class="bg-slate-800 p-3 rounded-2xl shadow-lg border border-slate-700">‚öôÔ∏è</button>
        </header>

        <!-- TIDSLOGGING -->
        <div class="card p-5">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xs font-black text-gray-400 uppercase tracking-widest">Arbeidstid</h2>
                <span id="period-label" class="text-[10px] bg-blue-900/50 text-blue-300 px-3 py-1 rounded-full border border-blue-800 uppercase font-black tracking-tighter">M√•ned</span>
            </div>
            <div class="flex gap-3">
                <input type="text" inputmode="decimal" id="hours-input" placeholder="0" 
                       class="w-24 p-4 bg-slate-900 text-white text-2xl border border-slate-700 focus:border-yellow-500 text-center font-black shadow-inner">
                
                <button onclick="window.subtractHours()" class="w-16 bg-red-900/20 text-red-500 border border-red-900/50 font-black rounded-2xl shadow active:scale-95 text-2xl">-</button>
                <button onclick="window.addHours()" class="flex-1 sweden-bg text-white font-black rounded-2xl shadow-xl active:scale-95 text-2xl">+</button>
            </div>
            <div class="flex justify-between mt-5 text-[11px] font-black text-gray-500 uppercase tracking-tighter">
                <span>Timer i perioden: <strong id="disp-curr-hours" class="text-white text-sm">0</strong></span>
                <span>L√∏nn: <strong id="disp-curr-salary" class="sweden-yellow text-sm">0 kr</strong></span>
            </div>
        </div>

        <!-- ARTIKELLOGGING -->
        <div class="card p-5 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-2 h-full bg-yellow-500"></div>
            <h2 class="text-xs font-black text-white mb-5 pl-2 uppercase tracking-widest">Registrer montasje</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] text-gray-500 uppercase font-black mb-1 block ml-1">Velg artikkel</label>
                    <select id="article-select" onchange="window.onArticleSelect()" 
                            class="custom-select w-full p-4 bg-slate-900 text-white text-lg border border-slate-700 focus:border-yellow-500 appearance-none font-bold shadow-inner">
                        <option value="">-- Velg artikkel --</option>
                    </select>
                </div>

                <div class="flex gap-4 items-end">
                    <div class="flex-1">
                        <label class="text-[10px] text-gray-500 uppercase font-black mb-1 block ml-1 tracking-widest">Mengde</label>
                        <input type="text" inputmode="decimal" id="article-qty" placeholder="0" 
                               class="w-full p-4 bg-slate-900 text-white text-2xl border border-slate-700 focus:border-yellow-500 text-center font-black shadow-inner">
                    </div>
                    <div class="w-1/3">
                        <label class="text-[10px] text-gray-500 uppercase font-black mb-1 block ml-1 tracking-tighter">Enhetspris</label>
                        <div id="disp-price" class="w-full p-4 bg-slate-800 text-gray-400 text-sm text-center border border-slate-700 font-mono font-bold italic">
                            -
                        </div>
                    </div>
                </div>

                <button onclick="window.addEntry()" class="w-full bg-green-600 hover:bg-green-500 text-white font-black py-5 rounded-2xl shadow-xl active:scale-95 flex justify-center items-center gap-3 transition-all">
                    <span class="text-3xl font-normal">+</span> 
                    <span class="text-lg uppercase">Legg til</span>
                </button>
                
                <div class="text-center">
                    <button onclick="window.showArticleManager()" class="text-[10px] text-blue-400 font-black uppercase tracking-widest p-2 opacity-60">
                        Rediger bibliotek
                    </button>
                </div>
            </div>
        </div>

        <!-- TOTAL PROSJEKTSTATISTIKK -->
        <div class="card p-6">
            <div class="flex justify-between items-center mb-5">
                <h2 class="text-sm font-black text-white uppercase tracking-widest italic">Hele prosjektet</h2>
                <button onclick="window.showMonterat()" class="bg-blue-600 text-white text-[10px] font-black px-4 py-2 rounded-xl shadow-lg active:scale-95 flex items-center gap-2 uppercase tracking-tighter hover:bg-blue-500 transition-colors">
                    üì¶ Montert totalt
                </button>
            </div>
            
            <div class="space-y-3">
                <div class="bg-slate-900 p-4 rounded-2xl border border-sweden-yellow flex justify-between items-center shadow-2xl">
                    <span class="text-[10px] text-gray-500 uppercase font-black">Totalresultat</span>
                    <span id="disp-proj-result" class="text-2xl font-black text-green-400 font-mono tracking-tighter">0 kr</span>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-slate-900 p-3 rounded-2xl border border-slate-700 text-center shadow-inner">
                        <div class="text-[9px] text-gray-500 uppercase font-black mb-1">Akkord Brutto</div>
                        <div id="disp-proj-akkord" class="text-base font-black text-blue-300 font-mono">0 kr</div>
                    </div>
                    <div class="bg-slate-900 p-3 rounded-2xl border border-slate-700 text-center shadow-inner">
                        <div class="text-[9px] text-gray-500 uppercase font-black mb-1">Snitt/t</div>
                        <div id="disp-proj-hourly" class="text-base font-black sweden-yellow font-mono">0 kr/t</div>
                    </div>
                </div>

                <div class="text-right text-[11px] text-gray-600 font-black uppercase tracking-widest pr-1 pt-2">
                    Totalt arbeidet: <span id="disp-proj-hours" class="text-gray-400 font-mono text-sm ml-1">0</span> t
                </div>
            </div>

            <!-- LOGGLISTA -->
            <div class="mt-8 pt-4 border-t border-slate-700">
                <h3 class="text-[10px] font-black text-gray-600 mb-4 uppercase tracking-[0.3em] text-center">Registrert denne m√•neden</h3>
                <div id="log-list" class="space-y-2 max-h-80 overflow-y-auto pb-4 pr-1 custom-scrollbar">
                    <!-- JS fyller rader -->
                </div>
            </div>
        </div>

        <!-- HANDLINGAR -->
        <div class="grid grid-cols-2 gap-4">
            <button onclick="window.startNewPeriod()" class="bg-orange-600 text-white font-black py-4 rounded-2xl shadow-xl text-xs uppercase active:scale-95 transition-transform">Steng m√•ned</button>
            <button onclick="window.saveSnapshot()" class="bg-teal-700 text-white font-black py-4 rounded-2xl shadow-xl text-xs uppercase active:scale-95 transition-transform">Lagre Snapshot</button>
        </div>
        
        <div class="pt-4 border-t border-gray-800">
            <label for="import-file-selector" class="import-label">
                üìÇ Gjenopprett Backup (JSON)
                <input type="file" id="import-file-selector" class="hidden" onchange="window.handleImport(this)">
            </label>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <button onclick="window.exportExcel()" class="bg-green-700 text-white font-black py-3 rounded-2xl shadow-lg text-[10px] uppercase">Eksporter Excel</button>
            <button onclick="window.exportJson()" class="bg-slate-800 text-gray-400 font-black py-3 rounded-2xl border border-slate-700 text-[10px] uppercase">Lagre Backup</button>
        </div>

        <button onclick="window.showHistory()" class="w-full bg-slate-800 text-blue-400 font-black py-3 rounded-2xl border border-slate-700 text-[10px] uppercase tracking-widest mt-2">
            Vis historikk
        </button>

        <div class="pt-6">
            <button onclick="window.resetAll()" class="w-full bg-red-950/20 text-red-900 font-black py-2 rounded-xl text-[8px] uppercase tracking-[0.4em] opacity-40 hover:opacity-100 transition-opacity">Nullstill alt</button>
        </div>
    </div>

    <!-- MODALER -->
    <div id="monterat-modal" class="modal-overlay">
        <div class="bg-slate-800 w-full max-w-md p-6 rounded-[2rem] border border-blue-500 shadow-2xl flex flex-col max-h-[85vh]">
            <h2 class="text-2xl font-black text-white uppercase tracking-tighter">Montert totalt</h2>
            <p class="text-[10px] text-gray-500 mb-6 uppercase font-black border-b border-slate-700 pb-2 tracking-widest">Full sammanst√§llning</p>
            <div id="monterat-list" class="flex-1 overflow-y-auto space-y-2 pr-2 custom-scrollbar"></div>
            <button onclick="document.getElementById('monterat-modal').classList.remove('active')" class="mt-6 w-full bg-blue-600 text-white py-4 rounded-2xl font-black shadow-lg uppercase tracking-widest">Lukk</button>
        </div>
    </div>

    <div id="article-modal" class="modal-overlay">
        <div class="bg-slate-800 w-full max-w-md p-6 rounded-[2rem] border border-slate-700 shadow-2xl">
            <h2 class="text-xl font-black text-white mb-4 uppercase tracking-tighter">Bibliotek</h2>
            <div class="space-y-4 mb-6 bg-slate-900/50 p-4 rounded-3xl border border-slate-700 shadow-inner">
                <input type="text" id="new-art-name" placeholder="Navn" class="w-full p-4 bg-slate-900 text-white rounded-xl border border-slate-700 font-bold outline-none shadow-inner">
                <div class="flex gap-3">
                    <input type="text" inputmode="decimal" id="new-art-price" placeholder="Pris" class="flex-1 p-4 bg-slate-900 text-white rounded-xl border border-slate-700 font-mono font-bold shadow-inner">
                    <select id="new-art-unit" class="w-24 p-4 bg-slate-900 text-white rounded-xl border border-slate-700 font-bold uppercase text-[10px]">
                        <option value="m">m</option>
                        <option value="st">st</option>
                        <option value="m¬≤">m¬≤</option>
                    </select>
                </div>
                <button onclick="window.saveNewArticle()" class="w-full bg-blue-600 text-white font-black py-4 rounded-xl uppercase shadow-lg">Lagre</button>
            </div>
            <div class="border-t border-slate-700 pt-4 max-h-48 overflow-y-auto custom-scrollbar" id="article-db-list"></div>
            <button onclick="document.getElementById('article-modal').classList.remove('active')" class="mt-4 w-full text-gray-500 font-black uppercase text-[10px] p-2">Lukk</button>
        </div>
    </div>

    <!-- MODAL FOR REDIGERING AV RAD -->
    <div id="edit-entry-modal" class="modal-overlay">
        <div class="bg-slate-800 w-full max-w-sm p-8 rounded-[2rem] border border-blue-500 shadow-2xl text-center">
            <h2 class="text-xl font-black text-white mb-2 uppercase tracking-tighter" id="edit-title">Korriger mengde</h2>
            <p class="text-[10px] text-gray-500 mb-6 uppercase font-black" id="edit-subtitle"></p>
            <input type="text" inputmode="decimal" id="edit-qty-input" class="w-full p-4 bg-slate-900 text-white text-2xl border border-slate-700 focus:border-yellow-500 text-center font-black shadow-inner mb-6 rounded-xl">
            <div class="flex justify-center gap-4">
                <button onclick="document.getElementById('edit-entry-modal').classList.remove('active')" class="bg-slate-700 text-gray-300 px-6 py-4 rounded-xl font-black uppercase text-[10px] tracking-widest">Avbryt</button>
                <button id="edit-save-btn" class="bg-blue-600 text-white px-8 py-4 rounded-xl font-black uppercase text-[10px] tracking-widest shadow-lg">Lagre endring</button>
            </div>
        </div>
    </div>

    <div id="history-modal" class="modal-overlay">
        <div class="bg-slate-800 w-full max-w-lg p-6 rounded-[2rem] border border-slate-700 shadow-2xl flex flex-col max-h-[90vh]">
            <h2 class="text-xl font-black text-white uppercase tracking-widest mb-4 italic text-center">Historikk</h2>
            <div id="history-content" class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scrollbar"></div>
            <button onclick="document.getElementById('history-modal').classList.remove('active')" class="mt-6 w-full bg-slate-700 py-3 rounded-2xl font-black uppercase text-xs">Lukk</button>
        </div>
    </div>

    <!-- DIALOGER -->
    <div id="confirm-modal" class="modal-overlay" style="z-index: 2000;">
        <div class="bg-slate-800 w-full max-w-sm p-8 rounded-[2rem] border border-slate-600 shadow-2xl text-center">
            <p id="confirm-msg" class="text-white text-lg mb-8 font-bold leading-tight"></p>
            <div class="flex justify-center gap-4">
                <button onclick="window.closeConfirm()" class="bg-slate-700 text-gray-300 px-6 py-4 rounded-xl font-black uppercase text-[10px] tracking-widest">Avbryt</button>
                <button id="confirm-yes-btn" class="bg-green-600 text-white px-8 py-4 rounded-xl font-black uppercase text-[10px] tracking-widest shadow-lg">Bekreft</button>
            </div>
        </div>
    </div>

    <div id="alert-modal" class="modal-overlay" style="z-index: 2000;">
        <div class="bg-slate-800 w-full max-w-sm p-8 rounded-[2rem] border border-slate-600 shadow-2xl text-center">
            <p id="alert-msg" class="text-white text-lg mb-8 font-bold leading-tight"></p>
            <button onclick="document.getElementById('alert-modal').classList.remove('active')" class="bg-blue-600 text-white px-12 py-4 rounded-xl font-black uppercase text-[10px]">OK</button>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay">
        <div class="bg-slate-800 w-full max-w-sm p-5 rounded-xl border border-slate-600 shadow-2xl">
            <h2 class="text-xl font-bold text-white mb-4 uppercase tracking-widest text-center">Innstillinger</h2>
            <div class="mb-4"><label class="text-[10px] text-gray-500 font-bold uppercase mb-1 block">Timel√∏nn (kr)</label><input type="text" inputmode="decimal" id="set-hourly-rate" onchange="window.updateSettings()" class="w-full p-4 bg-slate-900 text-white rounded-xl border border-slate-700 font-bold shadow-inner"></div>
            <div class="mt-4 flex justify-end"><button onclick="document.getElementById('settings-modal').classList.remove('active')" class="bg-green-600 text-white px-8 py-3 rounded-xl font-black uppercase text-[10px]">Lagre</button></div>
        </div>
    </div>

    <script>
        const DB_KEY = 'timjagaren_v6_norsk_db';
        
        let state = {
            settings: { hourlyRate: 0, baseAmount: 0 },
            articleLib: [ 
                { id: 'art_1', name: "Beslagskledning Balkong", price: 0, unit: 'm¬≤' }, 
                { id: 'art_2', name: "Endelukk", price: 0, unit: 'st' },
                { id: 'art_3', name: "Mellomstykke Balkong", price: 0, unit: 'st' }
            ],
            currentPeriod: { month: getMonthName(), hours: 0, log: [] },
            history: [],
            accumulatedSurplus: 0, 
            accumulatedHours: 0, 
            accumulatedAkkordTotal: 0
        };

        window.onload = () => { loadData(); sanitizeState(); renderUI(); };

        function getMonthName() {
            const m = ["Januar", "Februar", "Mars", "April", "Mai", "Juni", "Juli", "August", "September", "Oktober", "November", "Desember"];
            return m[new Date().getMonth()];
        }

        function loadData() {
            try {
                const raw = localStorage.getItem(DB_KEY);
                if(raw) {
                    const parsed = JSON.parse(raw);
                    state = { ...state, ...parsed };
                }
            } catch(e) { console.error("Laddning misslyckades", e); }
        }

        function getStandardName(name) {
            if(!name) return "Ukjent";
            const n = name.toLowerCase();
            if (n.includes("beslagskledning")) return "Beslagskledning Balkong";
            if (n.includes("mellanbit") || n.includes("mellomstykke") || n.includes("mellombit")) return "Mellomstykke Balkong";
            if (n.includes("endelukk") || n.includes("endelokk")) return "Endelukk";
            return name.trim();
        }

        function sanitizeState() {
             state.settings.hourlyRate = parseNum(state.settings.hourlyRate);
             state.currentPeriod.hours = parseNum(state.currentPeriod.hours);
             state.accumulatedSurplus = parseNum(state.accumulatedSurplus);
             state.accumulatedHours = parseNum(state.accumulatedHours);
             state.accumulatedAkkordTotal = parseNum(state.accumulatedAkkordTotal);

             if(!state.history) state.history = [];
             
             let cleanedLib = [];
             let seen = new Set();
             
             state.articleLib.forEach(art => {
                 if (!art || !art.name) return;
                 let n = getStandardName(art.name);
                 let lower = n.toLowerCase();
                 let unit = art.unit || 'm';

                 if (lower.includes("beslagskledning")) { unit = "m¬≤"; }
                 else if (lower.includes("balkong") || lower.includes("endelukk")) { unit = "st"; }

                 let key = n.toLowerCase();
                 if (!seen.has(key)) {
                     cleanedLib.push({ ...art, name: n, unit: unit });
                     seen.add(key);
                 }
             });
             state.articleLib = cleanedLib;

             state.currentPeriod.log.forEach(item => {
                 item.price = parseNum(item.price);
                 item.qty = parseNum(item.qty);
                 item.total = parseNum(item.total);
                 
                 item.name = getStandardName(item.name);
                 const lower = item.name.toLowerCase();
                 if (lower.includes("beslagskledning")) item.unit = "m¬≤";
                 else if (lower.includes("endelukk") || lower.includes("balkong")) item.unit = "st";
                 else if (!item.unit) item.unit = 'm';

                 if(!item.id) item.id = "id_" + Date.now() + "_" + Math.random();
             });
        }

        function saveData() {
            localStorage.setItem(DB_KEY, JSON.stringify(state));
            renderUI();
        }
        
        function renderUI() {
            const safeSet = (id, val, isMoney = false, isNum = false) => {
                const el = document.getElementById(id);
                if (el) {
                    if (isMoney) el.innerText = fmtMoney(parseNum(val));
                    else if (isNum) el.innerText = fmtNum(parseNum(val));
                    else el.innerText = val;
                }
            };

            safeSet('period-label', state.currentPeriod.month);
            safeSet('header-month-label', state.currentPeriod.month);
            
            const select = document.getElementById('article-select');
            if (select) {
                const currentVal = select.value;
                select.innerHTML = '<option value="">-- Velg artikkel --</option>';
                state.articleLib.forEach((art, index) => {
                    const opt = document.createElement('option');
                    opt.value = art.id;
                    opt.text = `${index + 1}. ${art.name} (${art.price} kr/${art.unit})`;
                    select.appendChild(opt);
                });
                if(currentVal) select.value = currentVal;
            }

            const monthlySalary = state.currentPeriod.hours * state.settings.hourlyRate; 
            let monthlyAkkordSum = 0;
            state.currentPeriod.log.forEach(item => monthlyAkkordSum += item.total);
            const monthlyResult = monthlyAkkordSum - monthlySalary;

            let historyHours = 0;
            let historyResult = 0;
            let historyAkkordSum = 0; 
            
            state.history.forEach(h => {
                if (!h.isSnapshot) { 
                    historyHours += parseNum(h.hours);
                    historyResult += parseNum(h.result); 
                    historyAkkordSum += h.akkordSum ? parseNum(h.akkordSum) : (h.log ? h.log.reduce((acc,i)=>acc+parseNum(i.total),0) : 0);
                }
            });

            const totalHours = historyHours + state.currentPeriod.hours + state.accumulatedHours;
            const projectAkkordTotal = historyAkkordSum + monthlyAkkordSum + state.accumulatedAkkordTotal;
            const totalResult = historyResult + monthlyResult + state.accumulatedSurplus; 
            const totalHourlyRate = totalHours > 0 ? totalResult / totalHours : 0;

            safeSet('disp-curr-hours', state.currentPeriod.hours, false, true);
            safeSet('disp-curr-salary', monthlySalary, true);
            
            const elResM = document.getElementById('disp-result-month');
            if(elResM) {
                elResM.innerText = fmtMoney(monthlyResult);
                elResM.className = `text-lg font-black font-mono ${monthlyResult >= 0 ? 'text-green-400' : 'text-red-400'}`;
            }

            safeSet('disp-proj-akkord', projectAkkordTotal, true);
            safeSet('disp-proj-result', totalResult, true);
            safeSet('disp-proj-hourly', fmtMoney(totalHourlyRate) + "/t");
            safeSet('disp-proj-hours', totalHours, false, true);

            const list = document.getElementById('log-list');
            if(list) {
                list.innerHTML = '';
                if(state.currentPeriod.log.length === 0) {
                    list.innerHTML = '<div class="text-center text-gray-700 text-[10px] py-10 font-black uppercase opacity-30 italic">Loggboken er tom</div>';
                } else {
                    const sortedLog = [...state.currentPeriod.log].sort((a, b) => {
                        const idxA = state.articleLib.findIndex(l => l.name.toLowerCase() === a.name.toLowerCase());
                        const idxB = state.articleLib.findIndex(l => l.name.toLowerCase() === b.name.toLowerCase());
                        return (idxA === -1 ? 999 : idxA) - (idxB === -1 ? 999 : idxB);
                    });

                    sortedLog.forEach((item) => {
                        const libIdx = state.articleLib.findIndex(l => l.name.toLowerCase() === item.name.toLowerCase());
                        const displayNum = libIdx !== -1 ? (libIdx + 1) : '?';

                        const div = document.createElement('div');
                        div.className = 'bg-slate-900 p-3 rounded-2xl border border-slate-800 flex justify-between items-center shadow-md mb-2 shadow-inner';
                        div.innerHTML = `
                            <div class="flex-1">
                                <div class="text-white font-black text-sm truncate pr-2">
                                    <span class="text-blue-500 mr-1 font-mono">${displayNum}.</span> ${item.name}
                                </div>
                                <div class="text-[9px] text-gray-500 font-bold uppercase">${fmtNum(item.qty)} ${item.unit} <span class="mx-1">|</span> ${item.price} kr</div>
                            </div>
                            <div class="text-right flex flex-col gap-1">
                                <div class="text-blue-400 font-mono font-black text-sm">${fmtMoney(item.total)}</div>
                                <div class="flex gap-2 justify-end">
                                    <button onclick="window.editEntry('${item.id}')" class="text-[8px] text-blue-300 font-black px-2 py-0.5 bg-slate-800 rounded uppercase border border-blue-900/30">Endre</button>
                                    <button onclick="window.removeEntry('${item.id}')" class="text-[8px] text-red-900 font-black px-2 py-0.5 bg-slate-950 rounded uppercase shadow-md active:bg-red-600 transition-colors">Slett</button>
                                </div>
                            </div>
                        `;
                        list.appendChild(div);
                    });
                }
            }
        }

        window.addHours = () => {
            const input = document.getElementById('hours-input');
            const val = parseNum(input.value);
            if(val > 0) { state.currentPeriod.hours += val; input.value = ''; saveData(); }
        };

        window.subtractHours = () => {
            const input = document.getElementById('hours-input');
            const val = parseNum(input.value);
            if(val > 0) { state.currentPeriod.hours -= val; if(state.currentPeriod.hours < 0) state.currentPeriod.hours = 0; input.value = ''; saveData(); }
        };

        window.onArticleSelect = () => {
            const id = document.getElementById('article-select').value;
            const display = document.getElementById('disp-price');
            const art = state.articleLib.find(a => a.id == id);
            if(art) {
                display.innerText = `${art.price} / ${art.unit}`;
                document.getElementById('article-qty').focus();
            } else { display.innerText = "-"; }
        };

        window.addEntry = () => {
            const id = document.getElementById('article-select').value;
            const qtyInput = document.getElementById('article-qty');
            const qty = parseNum(qtyInput.value);
            if(!id || qty === 0) return;
            const art = state.articleLib.find(a => a.id == id);
            const stdName = getStandardName(art.name);

            const existingIndex = state.currentPeriod.log.findIndex(i => i.name === stdName);

            if (existingIndex !== -1) {
                state.currentPeriod.log[existingIndex].qty += qty;
                state.currentPeriod.log[existingIndex].total = state.currentPeriod.log[existingIndex].qty * state.currentPeriod.log[existingIndex].price;
            } else {
                let unit = art.unit;
                const lower = stdName.toLowerCase();
                if (lower.includes("beslagskledning")) unit = "m¬≤";
                else if (lower.includes("endelukk") || lower.includes("balkong")) unit = "st";

                state.currentPeriod.log.push({ 
                    id: "id_" + Date.now() + "_" + Math.random(), 
                    name: stdName, 
                    price: art.price, 
                    qty: qty, 
                    unit: unit, 
                    total: art.price * qty 
                });
            }
            qtyInput.value = '';
            saveData();
        };

        window.removeEntry = (id) => {
            customConfirm("Slette raden?", () => { 
                state.currentPeriod.log = state.currentPeriod.log.filter(item => String(item.id) !== String(id));
                saveData(); 
            });
        };

        window.editEntry = (id) => {
            const entry = state.currentPeriod.log.find(i => String(i.id) === String(id));
            if(!entry) return;

            const modal = document.getElementById('edit-entry-modal');
            const input = document.getElementById('edit-qty-input');
            const subtitle = document.getElementById('edit-subtitle');
            const saveBtn = document.getElementById('edit-save-btn');

            subtitle.innerText = `${entry.name} (${entry.unit})`;
            input.value = entry.qty;
            
            saveBtn.onclick = () => {
                const newQty = parseNum(input.value);
                if(newQty >= 0) {
                    entry.qty = newQty;
                    entry.total = entry.qty * entry.price;
                    modal.classList.remove('active');
                    saveData();
                }
            };

            modal.classList.add('active');
            setTimeout(() => {
                input.focus();
                input.select();
            }, 100);
        };

        window.showMonterat = () => {
            const listEl = document.getElementById('monterat-list');
            listEl.innerHTML = '';
            let summary = {}; 

            const addToSummary = (name, qty, unit) => {
                const standardName = getStandardName(name);
                const lower = standardName.toLowerCase();
                
                let finalUnit = unit;
                if(lower.includes("endelukk") || lower.includes("balkong")) finalUnit = "st";
                if(lower.includes("beslagskledning")) finalUnit = "m¬≤";

                if(!summary[standardName]) {
                    summary[standardName] = { qty: 0, unit: finalUnit };
                }
                summary[standardName].qty += parseNum(qty);
            };

            state.currentPeriod.log.forEach(i => addToSummary(i.name, i.qty, i.unit));

            state.history.forEach(p => {
                if(!p.isSnapshot && p.log) {
                    p.log.forEach(i => addToSummary(i.name, i.qty, i.unit));
                }
            });

            const libraryNames = state.articleLib.map(a => a.name);
            const finalSortedKeys = [...libraryNames];
            Object.keys(summary).forEach(name => {
                if (!finalSortedKeys.includes(name)) finalSortedKeys.push(name);
            });

            let hasContent = false;
            finalSortedKeys.forEach(k => {
                if (summary[k] && summary[k].qty > 0) {
                    hasContent = true;
                    const data = summary[k];
                    const unit = k.toLowerCase().includes("endelukk") ? "st" : data.unit;
                    const libIdx = state.articleLib.findIndex(l => l.name.toLowerCase() === k.toLowerCase());
                    const displayNum = libIdx !== -1 ? (libIdx + 1) : '?';

                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-4 bg-slate-900 rounded-[1.2rem] border border-slate-700 mb-2 shadow-inner';
                    div.innerHTML = `<span class="font-black text-gray-300 text-xs truncate mr-2"><span class="text-blue-500 mr-1 font-mono">${displayNum}.</span> ${k}</span><span class="text-blue-400 font-black text-lg font-mono whitespace-nowrap">${fmtNum(data.qty)} <small class="text-gray-600 uppercase text-[9px]">${unit}</small></span>`;
                    listEl.appendChild(div);
                }
            });

            if (!hasContent) {
                 listEl.innerHTML = '<p class="text-center text-gray-700 py-10 uppercase text-[10px] font-black italic">Ingen data registrert</p>';
            }
            
            document.getElementById('monterat-modal').classList.add('active');
        };

        window.showSettings = () => {
            const el = document.getElementById('set-hourly-rate');
            if(el) el.value = state.settings.hourlyRate;
            document.getElementById('settings-modal').classList.add('active');
        };
        
        window.updateSettings = () => {
            state.settings.hourlyRate = parseNum(document.getElementById('set-hourly-rate').value);
            saveData();
        };

        window.showArticleManager = () => {
            const list = document.getElementById('article-db-list');
            list.innerHTML = '';
            state.articleLib.forEach((art, idx) => {
                list.innerHTML += `
                    <div class="flex justify-between items-center py-3 border-b border-slate-700/50 text-xs">
                        <div class="text-white font-bold">${idx + 1}. ${art.name} <span class="text-slate-500 lowercase">(${art.unit})</span></div>
                        <div class="flex items-center gap-3">
                            <span class="text-gray-500 font-mono">${art.price} kr</span>
                            <button onclick="window.deleteArticle(${idx})" class="text-red-900 bg-slate-950 p-2 rounded-lg">üóëÔ∏è</button>
                        </div>
                    </div>`;
            });
            document.getElementById('article-modal').classList.add('active');
        };

        window.saveNewArticle = () => {
            const name = document.getElementById('new-art-name').value;
            const price = parseNum(document.getElementById('new-art-price').value);
            let unit = document.getElementById('new-art-unit').value;
            if(name && !isNaN(price)) {
                state.articleLib.push({ id: "id_" + Date.now() + "_" + Math.random(), name: name.trim(), price, unit });
                document.getElementById('new-art-name').value = '';
                document.getElementById('new-art-price').value = '';
                document.getElementById('article-select').innerHTML = ""; 
                saveData(); 
                window.showArticleManager();
            }
        };

        window.deleteArticle = (idx) => {
            customConfirm("Slette artikkel?", () => { state.articleLib.splice(idx, 1); document.getElementById('article-select').innerHTML = ""; window.showArticleManager(); saveData(); });
        };

        window.startNewPeriod = () => {
            customConfirm(`Steng m√•neden?\nNullstiller n√•v√¶rende logg.`, () => {
                const salary = state.currentPeriod.hours * state.settings.hourlyRate;
                let akkordSum = 0;
                state.currentPeriod.log.forEach(i => akkordSum += i.total);
                state.history.unshift({
                    date: new Date().toISOString(), month: state.currentPeriod.month,
                    result: akkordSum - salary, hours: state.currentPeriod.hours,
                    akkordSum: akkordSum, log: [...state.currentPeriod.log], isSnapshot: false 
                });
                state.currentPeriod.month = getMonthName();
                state.currentPeriod.hours = 0;
                state.currentPeriod.log = [];
                saveData();
                customAlert("M√•ned stengt!");
            });
        };

        window.saveSnapshot = () => {
            customConfirm("Lagre en snapshot?", () => {
                const salary = state.currentPeriod.hours * state.settings.hourlyRate;
                let akkordSum = 0;
                state.currentPeriod.log.forEach(i => akkordSum += i.total);
                state.history.unshift({
                    date: new Date().toISOString(), month: state.currentPeriod.month + " (Snap)",
                    result: akkordSum - salary, hours: state.currentPeriod.hours,
                    akkordSum: akkordSum, log: JSON.parse(JSON.stringify(state.currentPeriod.log)), isSnapshot: true 
                });
                saveData();
                customAlert("Snapshot lagret i historikken!");
            });
        };

        window.showHistory = () => {
            const content = document.getElementById('history-content');
            if(state.history.length === 0) content.innerHTML = '<p class="text-center text-gray-500 py-10 font-bold uppercase text-[10px]">Ingen historikk</p>';
            else {
                content.innerHTML = state.history.map((h, i) => {
                    const isSnap = h.isSnapshot;
                    const borderColor = isSnap ? "border-teal-900" : "border-slate-700";
                    const bgColor = isSnap ? "bg-teal-900/10" : "bg-slate-800";
                    const result = parseNum(h.result);
                    
                    const itemsHtml = (h.log && h.log.length > 0) ? h.log.map(item => {
                        return `
                        <div class="grid grid-cols-12 gap-1 text-[10px] border-t border-slate-700 py-1">
                            <div class="col-span-6 truncate">${item.name}</div>
                            <div class="col-span-2 text-right">${fmtNum(item.qty)}</div>
                            <div class="col-span-4 text-right">${fmtMoney(item.total)}</div>
                        </div>`;
                    }).join('') : '<div class="text-[10px] text-gray-600 italic">Ingen rader registrert.</div>';

                    return `
                    <div class="${bgColor} p-4 rounded-2xl border ${borderColor} mb-3 shadow-sm">
                        <div class="flex justify-between font-black text-blue-300 uppercase text-[9px] tracking-widest mb-1">
                            <span>${h.month}</span> <span>${h.date ? h.date.split('T')[0] : ''}</span>
                        </div>
                        <div class="mb-3">Resultat: <span class="${result>=0?'text-green-400':'text-red-400'} font-mono font-black">${fmtMoney(result)}</span></div>
                        
                        <details class="mb-3">
                            <summary class="text-[10px] text-gray-400 cursor-pointer p-2 bg-slate-900/50 rounded-lg hover:text-white transition-colors">
                                Vis registrert materiell ‚ñº
                            </summary>
                            <div class="mt-2 bg-slate-900/50 p-2 rounded-xl max-h-40 overflow-y-auto custom-scrollbar">
                                <div class="grid grid-cols-12 gap-1 text-[8px] uppercase text-gray-500 font-bold mb-1">
                                    <div class="col-span-6">Artikkel</div>
                                    <div class="col-span-2 text-right">Antall</div>
                                    <div class="col-span-4 text-right">Summa</div>
                                </div>
                                ${itemsHtml}
                            </div>
                        </details>

                        <div class="flex gap-2">
                             <button onclick="window.exportHistoryExcel(${i})" class="flex-1 bg-green-900/30 text-green-500 font-black py-2 rounded-lg text-[9px] border border-green-900/50 shadow-md">Excel</button>
                             <button onclick="window.deleteHistoryEntry(${i})" class="flex-1 bg-red-900/10 text-red-900 font-black py-2 rounded-lg text-[9px] border border-red-900/50 shadow-md">Slett</button>
                        </div>
                    </div>
                `}).join('');
            }
            document.getElementById('history-modal').classList.add('active');
        };

        window.deleteHistoryEntry = (idx) => {
            customConfirm("Slette denne rapporten permanent?", () => {
                state.history.splice(idx, 1);
                saveData();
                window.showHistory();
            });
        };

        window.exportExcel = async () => {
            const salary = state.currentPeriod.hours * state.settings.hourlyRate;
            let akk = 0; state.currentPeriod.log.forEach(i => akk += i.total);
            const csv = generateCsv(state.currentPeriod.log, state.currentPeriod.month, state.currentPeriod.hours, salary, akk);
            await shareOrDownload(csv, `Timejegeren_${state.currentPeriod.month}.csv`);
        };

        window.exportHistoryExcel = async (idx) => {
            const h = state.history[idx];
            const salary = (parseNum(h.hours) || 0) * state.settings.hourlyRate; 
            const akk = parseNum(h.akkordSum) || (h.log ? h.log.reduce((acc,i)=>acc+parseNum(i.total),0) : 0);
            const csv = generateCsv(h.log || [], h.month, h.hours || 0, salary, akk);
            await shareOrDownload(csv, `Timejegeren_${h.month.replace(' ','_')}.csv`);
        };

        function generateCsv(logItems, monthName, hours, salary, akkord) {
            let csv = `\ufeffRAPPORT TIMEJEGEREN\nPeriode;${monthName}\nTimer;${fmtNum(hours)}\nL√∏nn;${fmtMoney(salary).replace('NOK','')}\nM√•nedsresultat;${fmtMoney(akkord - salary).replace('NOK','')}\n\n`;
            csv += `Nr;Artikkel;Antall;Enhet;Pris;Sum\n`;
            
            const sortedItems = [...logItems].sort((a, b) => {
                const idxA = state.articleLib.findIndex(l => l.name.toLowerCase() === a.name.toLowerCase());
                const idxB = state.articleLib.findIndex(l => l.name.toLowerCase() === b.name.toLowerCase());
                return (idxA === -1 ? 999 : idxA) - (idxB === -1 ? 999 : idxB);
            });

            sortedItems.forEach((i) => {
                const libIdx = state.articleLib.findIndex(l => l.name.toLowerCase() === i.name.toLowerCase());
                const displayNum = libIdx !== -1 ? (libIdx + 1) : '?';
                csv += `${displayNum};${i.name};${i.qty.toString().replace('.',',')};${i.unit};${i.price.toString().replace('.',',')};${i.total.toString().replace('.',',')}\n`; 
            });
            return csv;
        }

        async function shareOrDownload(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            if (navigator.canShare && navigator.share) {
                try {
                    const file = new File([blob], filename, { type: 'text/csv' });
                    await navigator.share({ files: [file], title: 'Rapport', text: 'Timejegeren' });
                    return;
                } catch (e) { console.warn("Share failed", e); }
            }
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
        }

        window.exportJson = () => {
            const blob = new Blob([JSON.stringify(state)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `Backup_${new Date().toISOString().split('T')[0]}.json`; a.click();
        }

        window.handleImport = (input) => {
            const file = input.files[0];
            if(!file) return;
            const r = new FileReader();
            r.onload = (e) => {
                try {
                    const content = e.target.result;
                    const parsed = JSON.parse(content);
                    
                    let impHourlyRate = parsed.settings?.hourlyRate || parsed.hourlyRate || state.settings.hourlyRate;
                    let impAccumSurplus = parseNum(parsed.accumulatedSurplus || parsed.historicalTotalSurplus || 0);
                    let impAccumHours = parseNum(parsed.accumulatedHours || 0);
                    let impAccumAkkord = parseNum(parsed.accumulatedAkkordTotal || 0);
                    let impHistory = parsed.history || [];
                    let impCurrentHours = parseNum(parsed.currentPeriod?.hours || parsed.totalHours || 0);
                    let impCurrentLog = parsed.currentPeriod?.log || [];
                    
                    let discoveredArticles = parsed.articleLib || [];

                    if (parsed.items && Array.isArray(parsed.items)) {
                        let legacyLogForMonterat = [];
                        let legacyHistoryAkkord = 0;

                        parsed.items.forEach(old => {
                             const p = parseNum(old.price || old.rate);
                             const qCurr = parseNum(old.totalQuantity || old.qty || 0);
                             const qHist = p > 0 ? (parseNum(old.historicalTotalSum || old.total || 0) / p) : 0;
                             const name = (old.article || old.name || "Okjent").trim();
                             if (!name) return;

                             const stdName = getStandardName(name);

                             if(!discoveredArticles.find(a => a.name === stdName)) {
                                 discoveredArticles.push({ id: "id_" + Date.now() + "_" + Math.random(), name: stdName, price: p, unit: stdName.toLowerCase().includes("beslagskledning") ? "m¬≤" : "m" });
                             }
                             if (qCurr > 0) {
                                 impCurrentLog.push({
                                     id: "id_" + Date.now() + "_" + Math.random(), name: stdName, price: p, qty: qCurr,
                                     unit: stdName.toLowerCase().includes('beslagskledning') ? 'm¬≤' : (stdName.toLowerCase().includes("endelukk") ? "st" : "m"),
                                     total: p * qCurr
                                 });
                             }
                             if (qHist > 0) {
                                 legacyLogForMonterat.push({
                                     name: stdName, price: p, qty: qHist,
                                     unit: stdName.toLowerCase().includes("beslagskledning") ? "m¬≤" : "m", 
                                     total: p * qHist
                                 });
                                 legacyHistoryAkkord += (p * qHist);
                             }
                        });

                        if (legacyLogForMonterat.length > 0 || impAccumSurplus > 0) {
                            impHistory.push({
                                date: new Date().toISOString(),
                                month: "Prosjektstart (Import)",
                                result: impAccumSurplus || (legacyHistoryAkkord - (impAccumHours * impHourlyRate)),
                                hours: impAccumHours,
                                akkordSum: legacyHistoryAkkord,
                                log: legacyLogForMonterat,
                                isSnapshot: false
                            });
                            impAccumSurplus = 0; impAccumHours = 0; impAccumAkkord = 0;
                        }
                    }

                    const scanForArticles = (list) => {
                        list.forEach(i => {
                            const std = getStandardName(i.name);
                            if (i.name && !discoveredArticles.find(a => a.name.toLowerCase() === std.toLowerCase())) {
                                discoveredArticles.push({ id: "id_" + Date.now() + "_" + Math.random(), name: std, price: i.price, unit: i.unit || 'm' });
                            }
                        });
                    };
                    scanForArticles(impCurrentLog);
                    impHistory.forEach(h => { if(h.log) scanForArticles(h.log); });

                    state.settings.hourlyRate = impHourlyRate;
                    state.history = impHistory;
                    state.currentPeriod.log = impCurrentLog;
                    state.currentPeriod.hours = impCurrentHours;
                    state.accumulatedSurplus = impAccumSurplus;
                    state.accumulatedHours = impAccumHours;
                    state.accumulatedAkkordTotal = impAccumAkkord;
                    state.articleLib = discoveredArticles;

                    sanitizeState();
                    document.getElementById('article-select').innerHTML = "";
                    saveData();
                    customAlert("Import lyckades!");
                } catch(err) { 
                    console.error(err);
                    customAlert("Import misslyckades."); 
                }
            };
            r.readAsText(file);
        };

        window.resetAll = () => { customConfirm("Slette ALT?", () => { localStorage.removeItem(DB_KEY); location.reload(); }); };
        window.currentConfirmCallback = null;
        
        function customAlert(msg) { document.getElementById('alert-msg').innerText = msg; document.getElementById('alert-modal').classList.add('active'); }
        
        function customConfirm(msg, callback) {
            document.getElementById('confirm-msg').innerText = msg;
            const yesBtn = document.getElementById('confirm-yes-btn');
            yesBtn.onclick = () => {
                document.getElementById('confirm-modal').classList.remove('active');
                callback();
            };
            document.getElementById('confirm-modal').classList.add('active');
        }
        
        window.closeConfirm = function() { document.getElementById('confirm-modal').classList.remove('active'); }

        function parseNum(v) { 
            if(v === undefined || v === null || isNaN(v)) return 0;
            if(typeof v === 'string') return parseFloat(v.replace(',', '.')) || 0; 
            return parseFloat(v) || 0; 
        }
        function fmtMoney(n) { return new Intl.NumberFormat('nb-NO', { style: 'currency', currency: 'NOK', maximumFractionDigits: 0 }).format(n); }
        function fmtNum(n) { return new Intl.NumberFormat('nb-NO', { maximumFractionDigits: 2 }).format(n); }
    </script>
</body>
</html>